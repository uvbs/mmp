<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title></title>
    <link href="/css/buttons2.css" rel="stylesheet" />
    <link href="/static-modules/lib/alert/style.css?v=1.0.0.1" rel="stylesheet" />
    <style type="text/css">
        .clear{
            clear:both;
        }
        .left{
            float:left;
        }
        .border0{
            border:0px !important;
        }
        .hidden{
            display:none;
        }
        .btnBack{
            margin-left:35px;
        }
        .warpContent {
            padding-top: 10px;
            padding-bottom: 100px;
        }
        .warpTree {
            font-size: 12px;
            color: #34495E;
        }
            .warpTree .monitorTitle {
                padding-left: 35px;
                padding-top: 14px;
                font-size: 18px;
            }
            .warpTree .node {
                border-left: 1px solid #7fB2E5;
                position: relative;
            }
                .warpTree .node .infoLine {
                    float: left;
                    width: 35px;
                    height: 52px;
                    border-bottom: 1px solid #7fB2E5;
                }
                .warpTree .node .info {
                    cursor: pointer;
                    border-radius: 5px;
                    border-color: #7fB2E5 !important;
                    border: 1px solid #ccc;
                    height: 70px;
                    width: 177px;
                    float: left;
                    margin-top: 15px;
                }
                    .warpTree .node .info ul {
                        list-style: none;
                        padding: 0px;
                        margin: 6px 0px;
                    }
                    .warpTree .node .info .avatar{
                        width:28px;
                        height:28px;
                        border-radius:50px;
                    }
                    .warpTree .node .info .userInfo {
                        width: 50px;
                        text-align: center;
                        overflow-x: hidden;
                        padding: 0px 5px;
                    }
                    .warpTree .node .info .countInfo {
                        width: 100px;
                        padding-left: 5px;
                    }
                .warpTree .node .totalCount {
                    padding-top: 14px;
                    padding-left: 36px;
                }
                 .warpTree .node .btnNodeFold {
                    height: 20px;
                    width: 20px;
                    display: inline-block;
                    position: absolute;
                    top: 42px;
                    left: -10px;
                }
                .warpTree .node .nodeFold {
                    border-bottom: 0;
                    background: url(img/node_fold.png) center no-repeat;
                }
                .warpTree .node .nodeUnFold {
                    border-bottom: 0;
                    background: url(img/node_unfold.png) center no-repeat;
                }
                .warpTree .node .children {
                    margin-left: 100px;
                }
            .warpTree .lastNode {
                border: 0px !important;
            }
                .warpTree .lastNode .infoLine {
                    border-left: 1px solid #7fB2E5;
                }
    </style>
</head>
<body>
    <div class="warpContent hidden">
        <a href="javascript:history.go(-1);" class="button button-rounded button-small btnBack">返回</a>
        <a href="javascript:;" class="button  button-primary button-rounded button-small btnShowAll">一键展开所有</a>
        <a href="javascript:;" class="button  button-primary button-rounded button-small btnHideAll">一键收起所有</a>
        <div class="warpTree">
            <div class="monitorTitle">
                《<span class="lbTitle"></span>》分享大数据统计树
            </div>
            <div class="root">
                <div class="node border0">
                    <div class="infoLine border0"></div>
                    <div class="info">
                        <div class="totalCount">
                            <div>分享总数：<span class="lbShareTotalCount">0</span></div>
                            <div>阅读总数：<span class="lbReadTotalCount">0</span></div>
                            <div>成果总数：<span class="lbAchievementTotalCount">0</span></div>
                        </div>
                    </div>
                    <div class="clear"></div>

                    <div class="children rootNode">

                        <div class="node">
                            <a href="javascript:;" class="btnNodeFold nodeUnFold"></a>
                            <div class="infoLine"></div>
                            <div class="info">
                                <ul>
                                    <li class="left userInfo">
                                        <div>
                                            <img src="/Admin/ShareMonitor/ShareTree/img/defuser.png" class="avatar" alt="头像" />
                                        </div>
                                        <div>charles</div>
                                    </li>
                                    <li class="left countInfo">
                                        <div>分享数：10000</div>
                                        <div>阅读数：10000</div>
                                        <div>子分享：10000</div>
                                        <div>成果数：10000</div>
                                    </li>
                                </ul>
                                <div class="clear"></div>
                            </div>
                            <div class="clear"></div>
                            <div class="children">
                                <div class="node">
                                    <a href="javascript:;" class="btnNodeFold nodeFold"></a>
                                    <div class="infoLine"></div>
                                    <div class="info">节点信息</div>
                                    <div class="clear"></div>
                                    <div class="children hidden">
                                        <div class="node">
                                            <div class="infoLine"></div>
                                            <div class="info">节点信息</div>
                                            <div class="clear"></div>
                                            <div class="children">
                                            </div>
                                        </div>
                                        <div class="node">
                                            <div class="infoLine"></div>
                                            <div class="info">节点信息</div>
                                            <div class="clear"></div>
                                            <div class="children">
                                            </div>
                                        </div>
                                        <div class="node">
                                            <div class="infoLine"></div>
                                            <div class="info">节点信息</div>
                                            <div class="clear"></div>
                                            <div class="children">
                                            </div>
                                        </div>
                                        <div class="node lastNode">
                                            <div class="infoLine"></div>
                                            <div class="info">节点信息</div>
                                            <div class="clear"></div>
                                            <div class="children">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="node lastNode">
                                    <div class="infoLine"></div>
                                    <div class="info">节点信息</div>
                                    <div class="clear"></div>
                                    <div class="children">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="node lastNode">
                            <div class="infoLine"></div>
                            <div class="info">
                                <ul>
                                    <li class="left userInfo">
                                        <div>
                                            <img src="/Admin/ShareMonitor/ShareTree/img/defuser.png" class="avatar" alt="头像" />
                                        </div>
                                        <div>未知用户</div>
                                    </li>
                                    <li class="left countInfo">
                                        <div>分享数：10000</div>
                                        <div>阅读数：10000</div>
                                        <div>子分享：10000</div>
                                        <div>成果数：10000</div>
                                    </li>
                                </ul>
                                <div class="clear"></div>
                            </div>
                            <div class="clear"></div>
                            <div class="children">
                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <script src="http://cdn.bootcss.com/jquery/2.1.3/jquery.min.js" type="text/javascript"></script>
    <script src="/static-modules/lib/layer/layer.min.js" type="text/javascript"></script>
    <script src="/Scripts/Common.js"></script>
    <script src="/Scripts/StringBuilder.js"></script>

    <script type="text/javascript">

        //数据模型
        var node = {
            user: {
                avatar: '',
                userName: '',
                userId: '',
                wxOpenId: ''
            },
            shareIds: ['1', '2'],
            preId: '',
            isHasChild: true,
            children: []
        }

        var $document = $(document),
            $warpTree = $document.find('.warpTree'),
            currMonitorId = GetParm('mid'),
            handlerUrl = '/Admin/ShareMonitor/Handler.ashx',
            currShareInfoData = [];
        
        var getShareData = function (dataKey) {
            if (currShareInfoData && currShareInfoData.length > 0) {
                for (var i = 0; i < currShareInfoData.length; i++) {
                    if (currShareInfoData[i].tmpDataKey == dataKey) {
                        return currShareInfoData[i];
                    }
                }
            }
            return false;
        }

        var createChildDom = function (dataList) {

            currShareInfoData = currShareInfoData.concat(dataList);

            var result = new StringBuilder();

            if (dataList) {
                for (var i = 0; i < dataList.length; i++) {
                    var nodeObj = dataList[i];
                    result.AppendFormat('<div class="node {0}" data-key="{1}" >', (i == dataList.length - 1) ? 'lastNode' : '', nodeObj.tmpDataKey);
                    result.AppendFormat('   {0}', nodeObj.childShareCount > 0 ? '<a href="javascript:;" class="btnNodeFold nodeFold"></a>' : '');
                    result.AppendFormat('   <div class="infoLine"></div>');
                    result.AppendFormat('   <div class="info">');
                    result.AppendFormat('       <ul>');
                    result.AppendFormat('           <li class="left userInfo">');
                    result.AppendFormat('               <div>');
                    result.AppendFormat('                   <img src="{0}" class="avatar" alt="头像" />', nodeObj.userInfo.avatar ? nodeObj.userInfo.avatar:'/Admin/ShareMonitor/ShareTree/img/defuser.png' );
                    result.AppendFormat('               </div>');
                    result.AppendFormat('               <div>{0}</div>', nodeObj.userInfo.userName == '' ? '未知用户' : nodeObj.userInfo.userName);
                    result.AppendFormat('           </li>');
                    result.AppendFormat('           <li class="left countInfo">');
                    result.AppendFormat('               <div>分享数：{0}</div>',nodeObj.shareCount);
                    result.AppendFormat('               <div>阅读数：{0}</div>',nodeObj.readCount);
                    result.AppendFormat('               <div>子分享：{0}</div>',nodeObj.childShareCount);
                    result.AppendFormat('               <div>成果数：{0}</div>',nodeObj.achievement);
                    result.AppendFormat('            </li>');
                    result.AppendFormat('        </ul>');
                    result.AppendFormat('        <div class="clear"></div>');
                    result.AppendFormat('    </div>');
                    result.AppendFormat('    <div class="clear"></div>');
                    result.AppendFormat('    <div class="children hidden">');
                    result.AppendFormat('    </div>');
                    result.AppendFormat('</div>');

                }
            }

            return result.ToString();
        }

        var showAll = function () {

            //$warpTree.find('.btnNodeFold.nodeFold').each(function () {
            //    var $this = $(this);
            //    setTimeout(function () {
            //        $this.click();
            //    }, 100);
            //});

            var showDoms = $warpTree.find('.btnNodeFold.nodeFold');

            for (var i = 0; i < showDoms.length; i++) {
                showNode(showDoms[i],false);
            }
            showDoms = $warpTree.find('.btnNodeFold.nodeFold');
            if (showDoms.length > 0) {
                showAll();
            }

        };

        var showNode = function (obj,async) {
            var $this = $(obj),
                   $node = $this.closest('.node'),
                   $children = $node.find('.children').first(),
                   dataKey = $node.attr('data-key');


            if ($this.hasClass('nodeFold')) {
                $this.removeClass('nodeFold').addClass('nodeUnFold');
                //展开
                var dataObj = getShareData(dataKey);
                var ids = dataObj.shareIds.join(',');

                var tmpChildHtml = $.trim($children.html());
                if (tmpChildHtml != '') {
                    $children.show();
                }
                else {
                    //读取远程数据并展开
                    //layer.load(0);
                    $.ajax({
                        type: 'post',
                        url: handlerUrl,
                        async: async,
                        data: { action: 'GetShareCountStatistics', mid: currMonitorId, preId: ids },
                        success: function (data) {
                            $children.html(createChildDom(data.shareResultList));
                            //layer.closeAll();
                            $children.show();

                        }
                    });
                }

            } else {
                $this.removeClass('nodeUnFold').addClass('nodeFold');
                //收起
                $children.hide();
            }
        }

        var init = function () {
            //获取当前monitorId，拉取服务器信息
            layer.load(0);
            $.ajax({
                type: 'post',
                url: handlerUrl,
                data: { action: 'GetShareCountStatistics',mid:currMonitorId,preId:'' },
                success: function (data) {
                    
                    //构造root内容
                    $warpTree.find('.monitorTitle .lbTitle').html(data.rootInfo.title);
                    $warpTree.find('.lbAchievementTotalCount').html(data.rootInfo.achievementTotalCount);
                    $warpTree.find('.lbReadTotalCount').html(data.rootInfo.readTotalCount);
                    $warpTree.find('.lbShareTotalCount').html(data.rootInfo.shareTotalCount);

                    $warpTree.find('.rootNode').html(createChildDom(data.shareResultList));

                    layer.closeAll();
                    $('.warpContent').fadeIn('fast');
                    

                }
            });

            $warpTree.on('click', '.btnNodeFold', function () {
                var $this = $(this),
                    $node = $this.closest('.node'),
                    $children = $node.find('.children').first(),
                    dataKey = $node.attr('data-key');

                if ($this.hasClass('nodeFold')) {
                    $this.removeClass('nodeFold').addClass('nodeUnFold');
                    //展开
                    var dataObj = getShareData(dataKey);
                    var ids = dataObj.shareIds.join(',');

                    var tmpChildHtml = $.trim($children.html());
                    if (tmpChildHtml != '') {
                        $children.show();
                    }
                    else {
                        //读取远程数据并展开
                        layer.load(0);
                        $.ajax({
                            type: 'post',
                            url: handlerUrl,
                            data: { action: 'GetShareCountStatistics', mid: currMonitorId, preId: ids },
                            success: function (data) {
                                $children.html(createChildDom(data.shareResultList));
                                layer.closeAll();
                                $children.show();
                            }
                        });
                    }
                    
                } else {
                    $this.removeClass('nodeUnFold').addClass('nodeFold');
                    //收起
                    $children.hide();
                }
            });

            //btnShowAll
            $document.on('click', '.btnHideAll', function () {
                $warpTree.find('.btnNodeFold').removeClass('nodeUnFold').addClass('nodeFold');
                $warpTree.find('.children').hide();
                $warpTree.find('.rootNode').show();
            });
            var isFirst = true;
            $document.on('click', '.btnShowAll', function () {
                if (isFirst) {
                    if (confirm('展开全部可能会出现暂时假死，确定一键展开？')) {
                        showAll();
                        isFirst = false;
                    }
                }
                else {
                    showAll();
                }
                
                

            });



        }

        init();

    </script>
</body>
</html>
