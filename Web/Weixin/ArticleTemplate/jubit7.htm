<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <title>$CCWX-ARTICLETITLE$</title>
    <link href="/Weixin/ArticleTemplate/css/comm.css?v=20160524" rel="stylesheet" />
    <!-- Bootstrap -->
    <link rel="stylesheet" href="/WuBuHui/css/wubu.css?v=0.0.1" />
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
        .col-xs-8 {
            width: 100%;
        }

        .mustinput {
            position: relative;
            top: 4px;
            left: 2px;
            color: red;
        }

        select {
            height: 30px;
            width: 100%;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            padding: 0 0px 0 0;
        }

        .w100P {
            width: 100%;
        }
    </style>
</head>
<body class="whitebg">
    <div class="wcontainer activetitle">
        <h1>
            $CCWX-ARTICLETITLE$
        </h1>
        <div class="tagbox">
            <span class="wbtn_tag wbtn_red"><span class="iconfont icon-eye"></span>$CCWX-ARTICLEOPENCOUNT$</span>
            <span class="wbtn_tag wbtn_orange">
                <span class="iconfont icon-36"></span>
                <label id="lblsignuptotalcounttop">
                    $CCWX-SIGNUPTOTALCOUNT$
                </label>
            </span>
        </div>
    </div>
    <div class="mainlist activelist activeinfomainlist">
        <!-- style="background-color:#000;http://www.baidu.com" -->
        <div class="listbox">
            <div class="mainimg">
                <img src="$CCWX-ARTICLEIMAGE$" />
            </div>
            <!--            <span class="wbtn_fly wbtn_flytr wbtn_greenyellow">费用：
            1积分 </span>-->

            <span class="baomingstatus">
                $CCWX-ACTIVITYSTATUS$
                <!--<span class="text">进行中 </span>
                <svg class="sanjiao" version="1.1" viewbox="0 0 100 100" >
                <polygon points="100,100 0.2,100 100,0.2" />
                </svg>-->
            </span>
            <div class="activeconcent">
                <div class="textbox">
                    <p>
                        <span class="iconfont icon-clock"></span><span class="text">$CCWX-ARTICLETIME$ </span>
                    </p>
                    <p>
                        <span class="iconfont icon-adress"></span><span class="text">地址:$CCWX-ARTICLEADDRESS$</span>
                    </p>
                </div>

            </div>
            <div class="wcontainer applyactive">
                <div class="applyactiveinbox">
                    <form action="" id="formsignin">
                        <div class="input-group">
                            <span class="input-group-addon">
                                <span class="iconfont icon-b24"></span><span class="mustinput">
                                    *
                                </span>
                            </span>
                            <input type="text" class="form-control" id="txtName" name="Name" placeholder="姓名"
                                   value="" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-addon">
                                <span class="iconfont icon-b47"></span><span class="mustinput">
                                    *
                                </span>
                            </span>
                            <input type="number" class="form-control" id="txtPhone" name="Phone" placeholder="手机号码"
                                   value="" />
                            <input id="hdIsSignIn" name="AutoSignIn" value="0"  type="hidden"  />
                            <input id="hdShareUserID" name="ShareUserID" value="" type="hidden" />
                            <input id="hdShareID" name="ShareID" value="" type="hidden" />
                        </div>
                    </form>
                    <div class="input-group activeinfosubmitbtn">
                        <span class="wbtn wbtn_main">
                            <span class="text" onclick="InsertData()">确认报名</span>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <!-- listbox -->
    </div>
    <!-- mainlist -->
    <div class="wcontainer articlebox">
        $CCWX-ARTICLECONTENT$
    </div>
    
    <div class="wcontainer articlebox">
    <!-- 可见区域 -->
    $CCWX-VISIBLEAREA$
    </div>

    $CCWX-SHAREUSERINFO$
    <div class="wcontainer articlebox bottom50">
        <div class="sharebtn">
            <span class="wbtn wbtn_main weixinsharezhidao">分享给好友</span> <span class="wbtn wbtn_main weixinsharezhidao">
                分享到朋友圈
            </span>
        </div>
    </div>
    <div class="wcontainer applypeoplelist" id="divpersionlist">
        <div class="listtitle">
            <h3 class="wbtn_line_orange">
                已报名
            </h3>
            <span class="wbtn_tag wbtn_orange">
                <span class="iconfont icon-36"></span>
                <label id="lblsignuptotalcountbottom">
                    $CCWX-SIGNUPTOTALCOUNT$
                </label>
            </span>
        </div>
        <div class="outerlistbox ">
            <div class="listbox loadmorebtn" id="append">
                <span id="btnloadmore" class="wbtn wbtn_main" onclick="LoadRPInfo()">显示更多</span>
            </div>
        </div>
    </div>
    <div class="footerbar">
        <!--        <div class="col-xs-2 ">
            <a class="wbtn wbtn_main" type="button" href="ActivityList.aspx"><span class="iconfont icon-back">
            </span></a>
        </div>-->
        <!-- /.col-lg-2 -->
        <div class="col-xs-8">
            $CCWX-ACTIVITYISSIGNIN7$
            <!--<span class="wbtn wbtn_line_main" id="applyactivebtn"><span class="iconfont icon-b55 smallicon"></span>立即报名</span>-->
        </div>
        <!-- /.col-lg-10 -->
        <!--           <div class="col-xs-2 ">
            <a class="wbtn wbtn_main" type="button" href="/wubuhui/MyCenter/Index.aspx"><span class="iconfont icon-b11">
            </span></a>
        </div>-->
        <!-- /.col-lg-2 -->
    </div>
    <!-- footerbar -->
    $CCWX-RELATIONARTICLE$
    <!--$CCWX-OTHERARTICLE$-->
    $CCWX-ARTICLEBOTTOM$
    
</body>
</html>
<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="/WuBuHui/js/jquery.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/WuBuHui/js/bootstrap.js"></script>
<script src="/wubuhui/js/weixinsharebtn.js" type="text/javascript"></script>
<script src="/WuBuHui/js/partyinfo.js"></script>
<script src="/WuBuHui/js/gotopageanywhere.js"></script>
<script src="/Scripts/jquery.form.js" type="text/javascript"></script>
<script src="/Scripts/Common.js"></script>
<script src="/Scripts/wxshare/wxshare0.0.1/wxshare.js"></script>
<script src="/Plugins/LayerM/layer.m.js" type="text/javascript"></script>

<script type="text/javascript">
    var pageData = {
        currUserOpenId: '$CCWX-currOpenerOpenID$', //当前用户的wxopenId
        currUserId: '$CCWX-currUserID$', //当前用户的userId
        title: '$CCWX-ARTICLETITLE$', //标题
        summary: '$CCWX-ARTICLESUMMARY$', //描述
        shareImgUrl: '$CCWX-ARTICLEIMAGE$', //分享缩略图
        shareUrl: window.location.href, //分享链接
        tempShareId: CreateGUID(),
        preShareId: GetParm('comeonshareid'),
        preShareUserId: '$CCWX-shareUserId$'//分享者id
        //callback: callback
    };

    //if (pageData.preShareUserId == pageData.currUserId) {
    //    pageData.tempShareId = pageData.preShareId;
    //}


</script>


<script type="text/javascript">
    var signUpId = '$CCWX-ARTICLSUGID$';//真实报名活动ID
    var juactivityId = '$CCWX-JUACTIVITYID$';//主表ID
    var PageIndex = 1;
    var isLogin = 0;
    var wxAuthPageMustLogin = 0;
    var appLoginUrl = '$CCWX-APPLOGINURL$';
    var layerIndex;
    $(function () {

        if (pageData.preShareUserId) {
            $('#hdShareUserID').val(pageData.preShareUserId);
        }

        if (pageData.preShareId) {
            $('#hdShareID').val(pageData.preShareId);
        }

        InitSignUpDataInfo();
        LoadRPInfo();
        window.alert = window.Alert = function (msg) {
            layerIndex = layer.open({
                content: msg,
                time: 2
            });
        };

        $("#hdIsSignIn").val(GetParm("autosignin"));

    });
    $("#btnloadmore").html("数据加载中");
    function LoadRPInfo() {
        $.ajax({
            type: 'post',
            url: "/Handler/OpenGuestHandler.ashx",
            data: { Action: "GetADInfos", PageIndex: PageIndex, ActivityId: signUpId },
            dataType: 'json',
            success: function (resp) {
                $("#btnloadmore").html("显示更多");
                if (resp.ExObj.length == 0 && PageIndex == 1) {
                    $("#btnloadmore").remove();
                    $("#append").html("<span class=\"color999\">暂无报名</span>");
                }
                PageIndex++;
                var html = "";
                if (resp.Status == 0) {

                    if (resp.ExObj.length == 0) {
                        $("#btnloadmore").html("没有更多");
                        $("#btnloadmore").removeAttr("onclick");
                        return;
                    }

                    $.each(resp.ExObj, function (index, Item) {
                        html += '<div class="listbox">';
                        html += '<span class="wbtn_round">';
                        html += '<img src="' + Item.K1 + '" alt="">';
                        html += '</span><span class="text">' + Item.Name + '</span><span class="time">' + Item.K2 + '</span>';
                        html += ' </div>';
                    });
                    $("#append").before(html);

                }
                else {
                    $("#btnloadmore").html("没有更多");
                }
            }
        });
    };
    function InsertData() {
        if (isLogin == 0 && wxAuthPageMustLogin == 1) {
            GotoLoginPage();
            return;
        }

        var loadIndex = layer.open({
            type: 2,
            shade: true,
            shadeClose:false
        });
        
        $("#formsignin").ajaxSubmit({
            url: "/serv/ActivityApiJson.ashx",
            type: "post",
            dataType: "json",
            success: function (resp) {
                layer.close(loadIndex);

                //$('#gnmdb').find("p").text(resp.Msg);
                //$('#gnmdb').modal('show');
                //$(".weixinshareshade").hide();

                alert(resp.Msg);

                if (resp.Status == 0) {
                    //报名成功
                    var oldcount = $("#lblsignuptotalcounttop").text();
                    var newcount = parseInt(oldcount) + 1;
                    $("#lblsignuptotalcounttop").html(newcount);
                    $("#lblsignuptotalcountbottom").html(newcount);
                    $("#btnloadmore").html("显示更多");
                    $("#btnloadmore").attr("onclick", "LoadRPInfo()");
                    if (IsGotoSignInPage()) {
                        return true;
                    }//是否跳到签到页面

                    if (resp.ExStr != '' && resp.ExStr != null) {
                        setTimeout("SignupUrl('" + resp.ExStr + "')", 2000);//1000为1秒钟
                    } else {
                        setTimeout(function () {
                            window.location.href = window.location.href;
                        }, 1800);
                    }
                }

            }
        });
        return false;
    };

    function SignupUrl(url) {
        location.href = url;
    }

    function InitSignUpDataInfo() {
        $.ajax({
            type: 'post',
            url: "/Handler/OpenGuestHandler.ashx",
            data: { Action: "SignUpDataInfo", signUpId: signUpId, pathname: window.location.pathname },
            dataType: 'json',
            success: function (resp) {
                var html = "";
                if (resp.Status == 0) {
                    if (resp.ExInt == 1) {//不显示报名列表
                        $("#divpersionlist").remove();

                    }
                    $.each(resp.ExObj, function (index, item) {

                        switch (item.InputType) {
                            case "combox": //下拉框
                                //
                                html += '<div class="input-group">';
                                html += '<span class="input-group-addon">' + item.MappingName;
                                if (item.FieldIsNull == 1) {
                                    html += '<span class="mustinput">*</span>';
                                }
                                html += '</span>';
                                html += '<select class="form-control" name=\"' + item.FieldName + '\">';
                                for (var i = 0; i < item.Options.split(',').length; i++) {
                                    var optionValue = item.Options.split(',')[i];
                                    html += '<option value=\"' + optionValue + '\">';
                                    html += optionValue;
                                    html += '</option>';

                                }
                                html += '</select>';
                                html += '</div>';
                                //
                                break;
                            case "checkbox": //多选框
                                //
                                html += '<div class="input-group">';
                                html += '<span class="input-group-addon">' + item.MappingName;
                                if (item.FieldIsNull == 1) {
                                    html += '<span class="mustinput">*</span>';
                                }
                                html += '</span>';
                                for (var i = 0; i < item.Options.split(',').length; i++) {
                                    var optionValue = item.Options.split(',')[i];
                                    html += '&nbsp;<input type=\"checkbox\" name=\"' + item.FieldName + '\" value=\"' + optionValue + '\" id=\"cb' + i + '\">';

                                    html += '&nbsp;<label for=\"cb' + i + '\">' + optionValue + '</label>';
                                    html += '<br/>';

                                }

                                html += '</div>';
                                //

                                break;
                            case "text": //文本框

                                //
                                if (item.IsMultiline == "1") {

                                    html += '<div class="input-group w100P">';

                                    html += '<textarea class=\"form-control\" rows=\"5\" type=\"text\" name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" value=\"\" placeholder=\"' + item.MappingName + '\" ></textarea>';

                                    html += '</div>';

                                } else {

                                    html += '<div class="input-group">';
                                    html += '<span class="input-group-addon">' + item.MappingName;

                                    if (item.FieldIsNull == 1) {
                                        html += '<span class="mustinput">*</span>';
                                    }

                                    html += '</span>';

                                    //if (item.IsMultiline == "1") {
                                    //    html += '<textarea rows=\"5\" type=\"text\" name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" value=\"\" placeholder=\"' + item.MappingName + '\" ></textarea>';
                                    //} else {
                                    html += '<input class=\"form-control\"  name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" placeholder=\"' + item.MappingName + '\" type=\"text\">';
                                    //}
                                    html += '</div>';

                                }
                                //

                                //
                                //html += '<div class="input-group">';
                                //html += '<span class="input-group-addon">' + item.MappingName;
                                //if (item.FieldIsNull == 1) {
                                //    html += '<span class="mustinput">*</span>';
                                //}
                                //html += '</span>';

                                //if (item.IsMultiline == "1") {
                                //    html += '<textarea rows=\"5\" type=\"text\" name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" value=\"\" placeholder=\"' + item.MappingName + '\" ></textarea>';
                                //} else {
                                //    html += '<input class=\"form-control\"  name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" placeholder=\"' + item.MappingName + '\" type=\"text\">';
                                //}

                                //html += '</div>';
                                //
                                break;
                            default:
                                //
                                if (item.IsMultiline == "1") {

                                    html += '<div class="input-group w100P">';

                                    html += '<textarea class=\"form-control\" rows=\"5\" type=\"text\" name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" value=\"\" placeholder=\"' + item.MappingName + '\" ></textarea>';

                                    html += '</div>';

                                } else {

                                    html += '<div class="input-group">';
                                    html += '<span class="input-group-addon">' + item.MappingName;

                                    if (item.FieldIsNull == 1) {
                                        html += '<span class="mustinput">*</span>';
                                    }

                                    html += '</span>';

                                    //if (item.IsMultiline == "1") {
                                    //    html += '<textarea rows=\"5\" type=\"text\" name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" value=\"\" placeholder=\"' + item.MappingName + '\" ></textarea>';
                                    //} else {
                                    html += '<input class=\"form-control\"  name=\"' + item.FieldName + '\" id=\"' + item.FieldName + '\" placeholder=\"' + item.MappingName + '\" type=\"text\">';
                                    //}
                                    html += '</div>';

                                }
                                //
                                break;

                        }




                    })
                    html += '<input id=\"activityID\" type=\"hidden\" value=\"' + signUpId + '\" name=\"ActivityID\" />';

                    //html += '<div class="input-group">';
                    //html += '<label>';
                    //html += '<input type="checkbox" id="chkIsSaveUserInfo" name="IsSaveUserInfo" value="1" /> 保存资料下次自动填充';
                    //html += '</label>';
                    //html += '</div>';

                    html += '<input type="hidden" id="chkIsSaveUserInfo" name="IsSaveUserInfo" value="1" checked />';

                    $("#formsignin").append(html);
                    $("#formsignin").append(resp.ExStr);
                    LoadUserData();
                }
                else {
                    Alert(resp.Msg);
                }
            }
        });
    };

    ///加载当前用户信息 如果可用
    function LoadUserData() {
        $.ajax({
            type: 'post',
            url: "/Handler/OpenGuestHandler.ashx",
            data: { Action: "GetCurrentUserInfo" },
            dataType: "json",
            success: function (resp) {
                if (resp.Status == 1) {
                    isLogin = 1;
                    $("#txtName").val(resp.ExObj.TrueName);
                    $("#txtPhone").val(resp.ExObj.Phone);
                    $("#formsignin").find("input[type='text'],textarea").each(function () {
                        var placeholder = $(this).attr("placeholder");
                        if (placeholder.indexOf("邮箱") >= 0 || placeholder.indexOf("邮件") >= 0 || placeholder.indexOf("email") >= 0 || placeholder.indexOf("Email") >= 0) {
                            $(this).val(resp.ExObj.Email);
                        }
                        if (placeholder.indexOf("公司") >= 0) {
                            $(this).val(resp.ExObj.Company);
                        }
                        if (placeholder.indexOf("职位") >= 0 || placeholder.indexOf("职务") >= 0) {
                            $(this).val(resp.ExObj.Postion);
                        }


                    });
                }
            }
        });

        $.ajax({
            type: 'post',
            url: "/Serv/API/Common/CheckWebsiteCommRelation.ashx",
            dataType: "json",
            data: { key: 'WXAuthPageMustLogin' },
            success: function (resp) {
                if (resp.status) {
                    wxAuthPageMustLogin = 1;
                }
            }
        });
    }
    function GotoLoginPage() {
        Alert("您还没有登录，请先登录");
        setTimeout(function () {
            document.location.href = appLoginUrl + '?redirect=' + encodeURI(document.location.href);
        }, 2000);
    }
</script>
<script type="text/javascript">
    //touchstart
    $("#applyactivebtn").unbind().bind("click", function () {
        if (isLogin == 0 && wxAuthPageMustLogin == 1) {
            GotoLoginPage();
            return;
        }
        gotopageanywhere('.activeinfomainlist', function () {
            if (!$(".applyactive").attr("style")) {
                var applyheight = $(".applyactiveinbox").height() + 10
                $(".applyactive").css({ "height": applyheight })
            }
        })
    })
</script>
<script type="text/javascript">
    //var pageData = {
    //    currUserOpenId: '$CCWX-currOpenerOpenID$', //当前用户的wxopenId
    //    currUserId: '$CCWX-currUserID$', //当前用户的userId
    //    title: '$CCWX-ARTICLETITLE$', //标题
    //    summary: '$CCWX-ARTICLESUMMARY$', //描述
    //    shareImgUrl: '$CCWX-ARTICLEIMAGE$', //分享缩略图
    //    shareUrl: window.location.href, //分享链接

    //    tempShareId: CreateGUID(),
    //    preShareId: GetParm('comeonshareid'),
    //    callback: callback
    //};

    var shareCallBackFunc = {
        timeline_s: function () {
            submitShare('timeline_s');
            shareComeplete('$CCWX-JUACTIVITYID$');
        },
        timeline_c: function () {
            //朋友圈分享取消
        },
        message_s: function () {
            //分享给朋友
            submitShare('message_s');
            shareComeplete('$CCWX-JUACTIVITYID$');
        },
        message_c: function () {
            //朋友分享取消
        }
    }

    var processUrl = function (url) {
        url = DelUrlParam(url, 'comeonshareid');
        url = DelUrlParam(url, 'from');
        url = DelUrlParam(url, 'isappinstalled');
        return url;
    }

    var callback = function (data) { }

    var submitShare = function (WxMsgType) {
        var reqData = {
            Action: 'ShareSubmit',
            url: processUrl(pageData.shareUrl),
            shareId: pageData.tempShareId,
            preId: pageData.preShareId,
            userId: pageData.currUserId,
            userWxOpenId: pageData.currUserOpenId,
            wxMsgType: WxMsgType
        }

        //分享到朋友圈
        $.ajax({
            type: 'post',
            url: '/serv/pubapi.ashx',
            data: reqData,
            dataType: 'jsonp',
            success: function (data) {
                pageData.tempShareId = CreateGUID();
            }
        });
    }

    //TODO:Url处理
    //移除原有参数 comeonshareid from isappinstalled
    pageData.shareUrl = processUrl(pageData.shareUrl);
    pageData.shareUrl = pageData.shareUrl + '?comeonshareid=' + pageData.tempShareId;


    wx.ready(function () {
        wxapi.wxshare({
            title: pageData.title,
            desc: pageData.summary,
            link: pageData.shareUrl,
            imgUrl: pageData.shareImgUrl
        }, shareCallBackFunc)
    });

    //报名成功是否跳到签到页面
    function IsGotoSignInPage() {

        if (GetParm("gotosigninpage") == "1") {

            window.location.href = "/app/cation/wap/signIn.aspx?id=" + juactivityId;
            return true;
        }
        return false;
    }
    //获取Get参数
    function GetParm(parm) {
        //获取当前URL
        var local_url = window.location.href;

        //获取要取得的get参数位置
        var get = local_url.indexOf(parm + "=");
        if (get == -1) {
            return "";
        }
        //截取字符串
        var get_par = local_url.slice(parm.length + get + 1);
        //判断截取后的字符串是否还有其他get参数
        var nextPar = get_par.indexOf("&");
        if (nextPar != -1) {
            get_par = get_par.slice(0, nextPar);
        }
        return get_par;
    }
    //获取参数

</script>

